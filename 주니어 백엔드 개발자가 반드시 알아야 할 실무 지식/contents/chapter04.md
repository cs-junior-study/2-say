# 4장 외부 연동이 문제일 때 살펴봐야 할 것들

생성일: 2025년 7월 2일 오후 4:39

<br><br>

### 우리는 문제가 없는데

장애는 연동하는 서비스에 장애가 발생하면 우리 서비스도 영향을 받는다. 

서비스 간 연동이 많아질수록 연동 시스템의 품질도 함께 신경 써야 한다.

<br><br>

### 타임 아웃

외부 연동에서 가장 중요한 설정은 **타임아웃**이다.

외부 서비스 장애 시 기다리는 만큼 스레드 풀을 잡고 있으므로 부하가 되는 것이다.

무한 대기보단, 빠르게 에러 화면이라도 보는 것이 낫다.

- 연결 타임아웃: 3초 ~ 5초
- 읽기 타임아웃: 5초 ~ 30초

<br>

정도로 적절히 선택, 잘못 선택하면 정상 처리했음에도 에러를 발생시킬 수 있다.


<br><br>


### 재시도

위 실패했다면, 재시도를 적용해볼 수 있다. 하지만, 항상 재시도를 할 수 있는 것은 아니다.

연동 API를 다시 호출해도 되는 조건인지 확인해야 한다.

<br>

재시도 가능 조건

- 단순 조회
- 연결 타임아웃
- 멱등성(idempotent)을 가진 변경 기능 → 좋아요가 이미 눌려져 있다면 다음은 아무 응답없이 200을 띄운다든지

<br>

- 재시도 횟수와 간격 설정
- 재시도 폭풍(retry storm) 안티 패턴 → 성능도 고려해봐야함.
- 동시 요청 제한 → 성능 한계를 초과하지 않는 수준에서 요청을 받도록

<br><br>

### 서킷 브레이커

연동 서비스에 과부하가 발생해 응답을 제대로 주지 못하는 상황에서 계속 응답 시간만 길어질 것이다.

이런 상황에서 바로 장애가 발생한 서비스에 요청을 보내지 않고 에러를 전달하도록 차단하는 기능을 서킷 브레이커라고 한다.

<br>

3가지 상태로 존재한다 (닫힘, 열림, 반열림)

- 닫힘 : 모든 서비스에 전달
- 열림: 연동 요청 수행하지 않고 바로 에러 응답 리턴 (FAIL FAST)
    - 기준
    - 시간 기준 오류 발생 비율 : EX) 10초 동안 오류 비율이 50% 초과
    - 개수 기준 오류 발생 비율: EX) 100개 요청 중 오류 비율이 50% 초과
- 반열림: 일부 요청에 한해 연동을 시도 (닫힘, 열림으로 변경하기 전 상태)

<br><br>

### 외부 연동과 트랜잭션 처리

외부 서비스 타임아웃이 났는데, 이후 외부 서비스가 성공했을 경우

- 일정 주기로 두 시스템의 데이터가 일치하는지 확인하고 보정하는 방법이 있다. (일관성이 중요하다면 이 방법 추천)
- 시간차를 두고 성공 확인 API 호출 한다. 성공이라면, 트랜잭션을 롤백하지않고 진행 실패면 롤백

보상 트랜잭션을 발행하는 방법도 있다.

<br>

내부 서비스에서 롤백했는데, 외부 서비스는 성공했을 때, 추후 비교해보고 보정하는 식으로 방안을 권장

<br><br>

### 외부 연동이 느려질 때, DB 커넥션 풀 문제

외부 연동을 db연결 전이나 후에 할 수 있다면 해보자 → but 트랜잭션 이용 불가 → 보상 트랜잭션 및 보정 고려

<br><br>

### HTTP 커넥션 풀

http 커넥션 풀을 사용할 때는 다음 3가지를 고려해야 한다. 

- HTTP 커넥션 풀의 크기
- 풀에서 HTTP 커넥션을 가져올 때까지 대기하는 시간
- HTTP 커넥션을 유지할 시간(keep alive)


<br><br>

### 연동 서비스 이중화

<br>

이중화 고려 여부

- 해당 기능이 서비스의 핵심인지 여부
- 이중화 비용이 감당 가능한 수준인지
